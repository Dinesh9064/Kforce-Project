# Milestone 3: Storage Account Auditing

This milestone implements storage account auditing functionality to track who or what has been accessing the storage account's blobs and file shares. It builds upon the infrastructure from Milestones 1 and 2.

## Implementation Approach

The implementation follows professional DevOps best practices by:

1. **Using Remote State** - References Milestones 1 and 2 resources through Terraform remote state
2. **Separate State Files** - Maintains a separate state file for better lifecycle management
3. **Comprehensive KQL Queries** - Provides detailed Kusto Query Language (KQL) queries for storage account auditing
4. **Test Resources** - Creates test containers and files to demonstrate audit functionality

## Resources Added

- **Enhanced Diagnostic Settings** - Configures detailed audit logging for the storage account
- **Test Storage Container** - For blob audit testing
- **Test File Share** - For file share audit testing
- **KQL Query Files** - Ready-to-use Kusto queries for various audit scenarios
- **Documentation** - Detailed instructions on using the KQL queries

## KQL Queries Provided

The implementation includes three sets of KQL queries:

1. **Blob Audit Queries**
    - Track all blob operations
    - Identify failed access attempts
    - Group operations by IP address
    - Detect anomalous access patterns

2. **File Share Audit Queries**
    - Monitor file share operations
    - Identify failed operations
    - Group operations by user agent
    - Track access by file path

3. **Combined Audit Queries**
    - Compare blob and file share operations
    - Audit authentication methods
    - Comprehensive security audit across all storage services

## Deployment Instructions

1. Initialize Terraform with the backend configuration:
   ```bash
   cd milestone3
   terraform init -backend-config=backend.conf
   ```

2. Plan the deployment:
   ```bash
   terraform plan -out=tfplan
   ```

3. Apply the configuration:
   ```bash
   terraform apply tfplan
   ```

## Validation

After deployment, you can validate the implementation by:

1. Checking the Log Analytics workspace for storage account logs
2. Running the provided KQL queries against your Log Analytics workspace
3. Verifying the test container and file share were created

## Using the KQL Queries

1. Navigate to the Azure Portal
2. Go to the Log Analytics workspace
3. Open the "Logs" blade
4. Copy and paste queries from the generated .kql files
5. Run the queries to analyze storage account access

For more detailed instructions, see the `README_KQL_QUERIES.md` file generated by this deployment.

## Best Practices Implemented

- **Remote State Pattern** - References existing resources without recreating them
- **Comprehensive Auditing** - Detailed logging of all storage operations
- **Security-First Approach** - Focus on identifying potential security issues
- **Test Data Generation** - Creates sample data for immediate testing
- **Documentation as Code** - Generates documentation alongside infrastructure